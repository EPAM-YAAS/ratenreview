angular.module("epam.review",["ngAnimate"]),function(){"use strict";angular.module("epam.review").directive("showErrors",function(){return{restrict:"A",require:"^form",link:function(scope,el,attrs,formCtrl){var inputEl=el[0].querySelector("[name]"),inputNgEl=angular.element(inputEl),inputName=inputNgEl.attr("name");inputNgEl.bind("blur",function(){el.toggleClass("has-error",formCtrl[inputName].$invalid)}),scope.$on("review:show-errors-check-validity",function(){el.toggleClass("has-error",formCtrl[inputName].$invalid)})}}})}(),function(){"use strict";angular.module("epam.review").directive("ratings",function(){return{restrict:"E",templateUrl:"src/templates/ratings.html",replace:!0,scope:{reviewScore:"@?",max:"@?",readonly:"@?",onScoreSelect:"&?"},controller:["$scope",function($scope){function updateStars(){$scope.stars=[];for(var i=0;i<$scope.max;i++)$scope.stars.push({filled:i<$scope.reviewScore})}$scope.reviewScore||($scope.reviewScore=0),$scope.max||($scope.max=5),$scope.onScoreSelect||($scope.onScoreSelect=function(){}),$scope.$watch("reviewScore",function(){updateStars()}),$scope.toggle=function(index){(void 0!==$scope.readonly||"false"===$scope.readonly)&&($scope.reviewScore=index+1,$scope.onScoreSelect({score:index+1}))}}]}})}(),function(){"use strict";angular.module("epam.review").directive("reviewForm",function(){return{restrict:"E",replace:!0,templateUrl:"src/templates/review-form.html",scope:{productId:"=",hideInput:"=?",productName:"="},controller:["$scope","$rootScope","ReviewSvc","$location","AuthSvc","GlobalData","Restangular","ReviewConfigSvc",function($scope,$rootScope,ReviewSvc,$location,AuthSvc,GlobalData,Restangular,ReviewConfigSvc){$scope.buildProductUrl=function(productId){return $location.protocol()+"://"+$location.host()+":"+$location.port()+"/#!/products/"+productId};var defaultReview={authorName:"",authorEmail:"",reviewText:"",rating:-1,productId:$scope.productId,productName:$scope.productName,productUrl:$scope.buildProductUrl($scope.productId)};$scope.review=angular.copy(defaultReview),$scope.rateReview=function(score){$scope.review.rating=score},$scope.submit=function(){$scope.$broadcast("review:show-errors-check-validity"),$scope.ReviewForm.$invalid||(ReviewSvc.postReview($scope.review,function(){$scope.$emit("review:review-posted")}),$scope.review=angular.copy(defaultReview))};var prePopulateAuthorAndEmail=function(){$scope.review.authorName=GlobalData.customerAccount?(GlobalData.customerAccount.firstName?GlobalData.customerAccount.firstName+" ":"")+(GlobalData.customerAccount.lastName?GlobalData.customerAccount.lastName:""):"",$scope.review.authorEmail=GlobalData.customerAccount?GlobalData.customerAccount.contactEmail:""},refreshAuthorAndEmail=function(){prePopulateAuthorAndEmail(),$scope.showAuthorName=""===$scope.review.authorName,$scope.showAuthorEmail=""===$scope.review.authorEmail},refreshAll=function(){refreshAuthorAndEmail(),Restangular.setBaseUrl(ReviewConfigSvc.baseUrl),AuthSvc.isAuthenticated()?(Restangular.all("reviews").getList({authorEmail:$scope.review.authorEmail,productId:$scope.productId}).then(function(response){$scope.showAllInputs=0===Restangular.stripRestangular(response).length}),Restangular.all("reviews").getList({authorEmail:$scope.review.authorEmail,productId:$scope.productId,reviewsStatus:"unapproved"}).then(function(response){$scope.showThanksForReview=Restangular.stripRestangular(response).length>0}),Restangular.all("reviews").getList({authorEmail:$scope.review.authorEmail,productId:$scope.productId,reviewsStatus:"approved"}).then(function(response){$scope.showAlreadyAddedReview=Restangular.stripRestangular(response).length>0}),$scope.showLogInToSendReviewButton=!1):($scope.showLogInToSendReviewButton=!0,$scope.showAllInputs=!1,$scope.showThanksForReview=!1,$scope.showAlreadyAddedReview=!1)};refreshAll(),$rootScope.$on("customer:login",refreshAll),$rootScope.$on("user:signedout",refreshAll),$rootScope.$on("review:review-posted",refreshAll)}]}})}(),function(){"use strict";angular.module("epam.review").directive("reviewList",function(){return{restrict:"E",templateUrl:"src/templates/review-list.html",scope:{productId:"="},controller:["$scope","ReviewSvc",function($scope,ReviewSvc){function getReviews(lastReviewId,pageSize,callback){ReviewSvc.getReviewsByParams({productId:$scope.productId,reviewsStatus:"approved",startFromExcluded:lastReviewId,pageSize:pageSize},callback)}$scope.canShowMore=!1,$scope.reviews=[],getReviews(null,3,function(reviews){$scope.reviews=$scope.reviews.concat(reviews)}),ReviewSvc.getReviewQuantityFor($scope.productId,function(data){data.value>3&&($scope.canShowMore=!0)}),$scope.onShowMore=function(){var lastReviewId=$scope.reviews[$scope.reviews.length-1].id;getReviews(lastReviewId,5,function(reviews){$scope.reviews=$scope.reviews.concat(reviews),reviews.length<5&&($scope.canShowMore=!1)})}}]}})}(),function(){"use strict";angular.module("epam.review").directive("review",function(){return{restrict:"E",templateUrl:"src/templates/review.html",replace:!0,scope:{review:"="}}})}(),function(){"use strict";angular.module("epam.review").directive("showMore",function(){return{restrict:"E",templateUrl:"src/templates/show-more.html",scope:{onShowMore:"&"},controller:["$scope",function($scope){$scope.spinning=!1,$scope.onMoreClick=function(){$scope.spinning=!0,$scope.onShowMore&&window.setTimeout(function(){$scope.onShowMore(),$scope.spinning=!1,$scope.$apply()},1e3)}}]}})}(),function(){"use strict";angular.module("epam.review").factory("RateSvc",["Restangular","ReviewConfigSvc",function(Restangular,reviewConfig){return{Rate:Restangular.withConfig(function(RestangularConfigurer){RestangularConfigurer.setBaseUrl(reviewConfig.baseUrl)}),getRatingByProductId:function(productIdParam,success){this.Rate.all("ratings").all("summary").customGET("",{productId:productIdParam}).then(function(response){success(Restangular.stripRestangular(response))})},getRatingsByProductIds:function(productIdsParam,success){this.Rate.all("ratings/summary").customGET("batch",{productIds:productIdsParam}).then(function(response){success(Restangular.stripRestangular(response))})}}}])}(),function(){"use strict";angular.module("epam.review").factory("ReviewConfigSvc",[function(){return{baseUrl:"https://api.yaas.io/epam/rate-review/v1"}}])}(),function(){"use strict";angular.module("epam.review").factory("ReviewSvc",["Restangular","ReviewConfigSvc",function(Restangular,reviewConfig){return{Review:Restangular.withConfig(function(RestangularConfigurer){RestangularConfigurer.setBaseUrl(reviewConfig.baseUrl)}),postReview:function(review,success){this.Review.all("reviews").post(review).then(success)},getReviewsByParams:function(params,success){this.Review.all("reviews").getList(params).then(function(response){success(Restangular.stripRestangular(response))})},getReviewQuantityFor:function(productId,success){this.Review.all("reviews").all("quantity").customGET("",{productId:productId}).then(function(response){success(Restangular.stripRestangular(response))})}}}])}(),function(){"use strict";angular.module("epam.review").filter("ratings",function(){return function(val,range,filled){range=parseInt(range),filled=parseInt(filled);for(var i=1;filled>=i;i++)val.push(i);for(var j=filled+1;range>=j;j++)val.push(0);return val}})}(),angular.module("epam.review").run(["$templateCache",function($templateCache){"use strict";$templateCache.put("src/templates/ratings.html",'<div class="star-rating">\r\n  <span ng-repeat="star in stars" class="star"\r\n        ng-class="{\'star-filled\': star.filled, \'star-cursor-pointer\':readonly===\'false\'}"\r\n        ng-click="toggle($index)">\r\n    <i class="glyphicon glyphicon-star"></i>\r\n  </span>\r\n</div>\r\n'),$templateCache.put("src/templates/review-form.html",'<div class="review-form">\r\n    <div class="review-form-header">\r\n        <h3>Product review </h3>\r\n    </div>\r\n    <div class="review-form-body">\r\n        <div class="description" ng-if="showThanksForReview">\r\n            <p class="messages-block">Thanks! Your comment was added and will be published after review</p>\r\n        </div>\r\n        <div class="description" ng-if="showAlreadyAddedReview">\r\n           <p class="messages-block">You have already added a review</p>\r\n        </div>\r\n                \r\n        <form name="ReviewForm">\r\n            <div ng-if="showAllInputs">\r\n	            <div class="review-form-ratings">\r\n	                <ratings readonly="false" on-score-select="rateReview(score)"></ratings>\r\n	            </div>\r\n	            <div class="form-group" ng-if="showAuthorName" show-errors>\r\n	                <label for="authorName"> Author name* </label>\r\n	                <input type="text" class="form-control" id="authorName" name="authorName" ng-model="review.authorName"\r\n	                       required/>\r\n	\r\n	                <p class="error-msg" ng-if="ReviewForm.authorName.$error.required">The author\'s name is required</p>\r\n	            </div>\r\n	            <div class="form-group" ng-if="showAuthorEmail" show-errors>\r\n	                <label for="authorEmail"> Author email* </label>\r\n	                <input type="email" class="form-control" id="authorEmail" name="authorEmail"\r\n	                       ng-model="review.authorEmail" required/>\r\n	\r\n	                <p class="error-msg" ng-if="ReviewForm.authorEmail.$error.required">The authors\'s email is required</p>\r\n	\r\n	                <p class="error-msg" ng-if="ReviewForm.authorEmail.$error.email">The email address is invalid</p>\r\n	            </div>\r\n	            <div class="form-group">\r\n	                <label for="reviewText"> Review text </label>\r\n	                <textarea class="form-control" type="textarea" id="reviewText" name="reviewText"\r\n	                          maxlength="140" rows="6"\r\n	                          ng-model="review.reviewText" ></textarea>\r\n	            </div>\r\n	\r\n	            <button type="button" ng-click="submit()" id="submit" name="submit" class="btn btn-primary pull-right">\r\n	                Send review\r\n	            </button>\r\n            </div>\r\n                      \r\n            <div class="login-button-holder">\r\n				<button type="button" ng-if="showLogInToSendReviewButton" class="btn btn-primary" onclick="javascript:document.getElementById(\'login-btn\').click();">\r\n					Sign in to write a review...\r\n				</button>\r\n			</div>\r\n        </form>\r\n    </div>\r\n</div>\r\n'),$templateCache.put("src/templates/review-list.html",'<div>\r\n  <review ng-repeat="review in reviews" review="review"></review>\r\n\r\n  <h3 ng-if="reviews.length==0" style="text-align: center">No reviews</h3>\r\n\r\n  <show-more on-show-more="onShowMore()" ng-if="canShowMore"></show-more>\r\n\r\n</div>\r\n'),$templateCache.put("src/templates/review.html",'<div class="row review">\r\n  <div class="col-md-12">\r\n    <div class="row">\r\n      <div class="col-md-8">\r\n\r\n        <span ng-bind-html="review.authorName" class="review-user-name"></span>\r\n        <span ng-bind-html="review.createdAt  | date:\'dd MMMM yyyy\'" class="review-date"></span>\r\n      </div>\r\n      <div class="col-md-4">\r\n        <ratings review-score="{{review.rating}}" class="pull-right-md" ng-if="review.rating > 0"></ratings>\r\n      </div>\r\n    </div>\r\n  </div>\r\n  <div class="col-md-12 review-content">\r\n    <span ng-bind-html="review.reviewText"></span>\r\n  </div>\r\n</div>\r\n'),$templateCache.put("src/templates/show-more.html",'<div class="show-more-wrapper">\r\n  <a class="btn btn-link show-more-text" ng-click="onMoreClick()"\r\n  ng-mouseenter="hover = true" ng-mouseleave="hover = false">\r\n  <span class="btn btn-circle btn-xl" ng-class="{\'cirle-hover\':hover, \'cirle-raw\':!hover}">\r\n    <i class="glyphicon glyphicon-repeat" ng-class="{\'circle-spin\':spinning}"/>\r\n  </span>\r\n  <span ng-bind-html="\'SHOW MORE\'"  />\r\n</a>\r\n</div>\r\n')}]);